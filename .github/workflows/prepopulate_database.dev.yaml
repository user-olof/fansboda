# In .github/workflows/prepopulate_database.dev.yaml
name: 5a. Prepopulate Dev Database
run-name: ${{ github.actor }} is prepopulating the dev database  ðŸš€
on: 
  workflow_run:
      workflows: ["4a. Deploy Dev to VM"] # Run the deploy after successful Build and Test
      types:
        - completed     

jobs:
  prepopulate_database:
    runs-on: ubuntu-latest
    environment: dev
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - uses: actions/checkout@v4

    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v1
      with:
        credentials_json: "${{ secrets.GCP_SVC_ACCOUNT_KEY }}"

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ vars.GCP_PROJECT_ID }}

    - name: Get IMAGE_URI from previous workflow
      id: get_image_uri
      run: |
        # For dev deployment, we use Docker Hub images, not GCP Artifact Registry
        # Construct the Docker Hub image URI
        IMAGE_URI="${{ secrets.DOCKER_USERNAME }}/${{ vars.DOCKER_IMAGE_NAME }}:${{ github.event.workflow_run.run_number }}"

        echo "image_uri=$IMAGE_URI" >> $GITHUB_OUTPUT
        echo "Using IMAGE_URI: $IMAGE_URI"

    - name: Prepopulate Dev Database
      run: |
        gcloud run jobs create prepopulate-db-dev-${{ github.run_number }} \
          --image "${{ steps.get_image_uri.outputs.image_uri }}" \
          --region ${{ vars.GCP_REGION }} \
          --project ${{ vars.GCP_PROJECT_ID }} \
          --service-account ${{ secrets.GCP_SVC_ACCOUNT }} \
          --set-env-vars FLASK_APP=app.py,FLASK_ENV=${{ vars.FLASK_ENV }} \
          --update-secrets DATABASE_URL=DATABASE_URL_DEV:latest,SECRET_KEY=SECRET_KEY:latest   \
          --command "python" \
          --args "scripts/prepopulate_development.py" \
          --cpu 1 \
          --memory 512Mi \
          --max-retries 3 \
          --parallelism 1 \
          --tasks 1

        gcloud run jobs execute prepopulate-db-dev-${{ github.run_number }} \
          --region ${{ vars.GCP_REGION }} \
          --project ${{ vars.GCP_PROJECT_ID }} \
          --wait

        gcloud run jobs delete prepopulate-db-dev-${{ github.run_number }} \
          --region ${{ vars.GCP_REGION }} \
          --project ${{ vars.GCP_PROJECT_ID }} \
          --quiet