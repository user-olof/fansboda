name: 5. Create Release Draft in Production
run-name: ${{ github.actor }} is creating a release draft in Production  ðŸš€

on:
  workflow_dispatch:


jobs:
  create_release_draft:
    runs-on: ubuntu-latest
    environment: prod
    

    steps:
      - name: Checkout
        uses: actions/checkout@v4
    
      - name: Get Latest Release Tag
        id: get_latest_tag
        run: |
          git fetch --tags
          LATEST_TAG=$(git tag -l --sort=-version:refname | head -n 1)
          if [ -z "$LATEST_TAG" ]; then
            echo "No tags found, starting at 0.0.0"
            echo "LATEST_TAG=0.0.0" >> $GITHUB_OUTPUT
          else
            echo "LATEST_TAG=$LATEST_TAG" >> $GITHUB_OUTPUT
            echo "Latest tag found: $LATEST_TAG"
          fi

      - name: Increase Latest Tag
        id: increase_latest_tag
        run: |
          LATEST_TAG="${{ steps.get_latest_tag.outputs.LATEST_TAG }}"
          
          # Extract version components
          PATCH_VERSION=$(echo "$LATEST_TAG" | awk -F. '{ print $3 }')
          MINOR_VERSION=$(echo "$LATEST_TAG" | awk -F. '{ print $2 }')
          MAJOR_VERSION=$(echo "$LATEST_TAG" | awk -F. '{ print $1 }')
          
          # Increment logic
          if [ "$PATCH_VERSION" -eq 9 ]; then
            if [ "$MINOR_VERSION" -eq 9 ]; then
              INCREASED_TAG="$((MAJOR_VERSION + 1)).0.0"
            else
              INCREASED_TAG="$MAJOR_VERSION.$((MINOR_VERSION + 1)).0"
            fi
          else
            INCREASED_TAG="$MAJOR_VERSION.$MINOR_VERSION.$((PATCH_VERSION + 1))"
          fi
          
          echo "INCREASED_LATEST_TAG=$INCREASED_TAG" >> $GITHUB_OUTPUT
          echo "Increased tag: $LATEST_TAG -> $INCREASED_TAG"

      - name: Create Release Draft
        run: |
          ./scripts/create-release.sh ${{ steps.increase_latest_tag.outputs.INCREASED_LATEST_TAG }}