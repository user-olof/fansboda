name: 7. Deploy Production to VM
run-name: ${{ github.actor }} is deploying to VM - Production  ðŸš€
on: 
  workflow_run:
      workflows: ["6. Push Image To Docker Hub in Production"] # Run the deploy after successful Build and Test
      types:
        - completed     

jobs:
  deploy_to_vm:
    runs-on: ubuntu-latest
    environment: prod
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
    - uses: actions/checkout@v4


    - name: Authenticate with Google Cloud
      uses: google-github-actions/auth@v3
      with:
        credentials_json: "${{ secrets.GCP_SVC_ACCOUNT_KEY }}"
      
    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1
      with:
        project_id: ${{ vars.GCP_PROJECT_ID }}

    - name: Configure Docker to use gcloud as a credential helper
      run: |
        gcloud auth configure-docker ${{ vars.GCP_REGION }}-docker.pkg.dev   

    - name: Authenticate with service account key
      run: |
        gcloud auth activate-service-account --key-file='${{ secrets.GCP_SVC_ACCOUNT_KEY }}'

    - name: Create fansboda directory on VM
      run: |
        gcloud compute ssh ${{ vars.GCP_VM_NAME }} \
          --zone=us-central1-a \
          --project=${{ vars.GCP_PROJECT_ID }} \
          --tunnel-through-iap \
          --quiet \
          --command "mkdir -p ~/fansboda ~/fansboda/certbot-webroot ~/fansboda/certificates"

    - name: Upload Docker Compose to Compute Engine Instance
      run: |
        gcloud compute scp docker-compose.production.yml nginx.conf nginx-acme.conf ${{ vars.GCP_VM_NAME }}:~/fansboda/ \
          --zone=us-central1-a \
          --project=${{ vars.GCP_PROJECT_ID }} \
          --tunnel-through-iap \
          --quiet

        gcloud compute scp --recurse static ${{ vars.GCP_VM_NAME }}:~/fansboda/ \
          --zone=us-central1-a \
          --project=${{ vars.GCP_PROJECT_ID }} \
          --tunnel-through-iap \
          --quiet

      # gcloud compute scp --recurse certificates ${{ vars.GCP_VM_NAME }}:~/fansboda/ --zone=us-central1-a 2>/dev/null || true

    - name: Upload service account key and create .env file
      run: |
        # Encode the service account key to base64
        ENCODED_KEY=$(echo -n '${{ secrets.GCP_SVC_ACCOUNT_KEY }}' | base64 -w 0)
        
        gcloud compute ssh ${{ vars.GCP_VM_NAME }} \
          --zone=us-central1-a \
          --project=${{ vars.GCP_PROJECT_ID }} \
          --tunnel-through-iap \
          --quiet \
          --command "cd ~/fansboda && 
          mkdir -p secrets &&
          sudo chmod 777 secrets &&
          echo '$ENCODED_KEY' | base64 -d > secrets/GCP_SVC_ACCOUNT_KEY.json &&
          sudo chmod 600 secrets/GCP_SVC_ACCOUNT_KEY.json &&
          cat > .env << 'ENVEOF'
        DATABASE_URL=${{ secrets.DATABASE_URL }}
        SECRET_KEY=${{ secrets.SECRET_KEY }}
        ALLOWED_EMAILS=${{ secrets.ALLOWED_EMAILS }}
        GOOGLE_APPLICATION_CREDENTIALS=/fansboda/secrets/GCP_SVC_ACCOUNT_KEY.json
        GOOGLE_CLOUD_PROJECT=${{ vars.GCP_PROJECT_ID }}
        GOOGLE_CLOUD_REGION=${{ vars.GCP_REGION }}
        FLASK_ENV=${{ vars.FLASK_ENV }}
        ENVEOF"

    - name: Configure Docker Hub authentication on VM
      run: |
        gcloud compute ssh ${{ vars.GCP_VM_NAME }} \
          --zone=us-central1-a \
          --project=${{ vars.GCP_PROJECT_ID }} \
          --tunnel-through-iap \
          --quiet \
          --command "echo '${{ secrets.DOCKER_TOKEN }}' | docker login -u '${{ secrets.DOCKER_USERNAME }}' --password-stdin"

    - name: Pull and Run Docker image to Compute Engine Instance
      run: |
        gcloud compute ssh ${{ vars.GCP_VM_NAME }} \
          --zone=us-central1-a \
          --project=${{ vars.GCP_PROJECT_ID }} \
          --tunnel-through-iap \
          --quiet \
          --command "cd ~/fansboda && 
          docker compose -f docker-compose.production.yml down && 
          docker container prune -f && 
          docker compose -f docker-compose.production.yml pull && 
          docker compose -f docker-compose.production.yml up -d --build"


    
    
        

        
    

