services:
  # Flask application
  web:
    image: oloft/fansboda-dev:latest
    container_name: fansboda-web
    restart: unless-stopped
    environment:
      - FLASK_ENV=development
      - GOOGLE_APPLICATION_CREDENTIALS=/app/secrets/GCP_SVC_ACCOUNT_KEY.json
    volumes:
      - ./static:/app/static:ro # Mount static files for nginx
      - ./secrets/GCP_SVC_ACCOUNT_KEY.json:/app/secrets/GCP_SVC_ACCOUNT_KEY.json:ro  # Add this
    networks:
      - fansboda-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8080/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 90s

  # Nginx reverse proxy
  nginx:
    image: nginx:alpine
    container_name: fansboda-nginx
    restart: unless-stopped
    ports:
      - "80:80" # HTTP - redirects to HTTPS
      - "443:443" # HTTPS - main application
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./static:/var/www/static:ro
      - ./certificates:/etc/nginx/ssl:ro # Mount SSL certificates
      - ./certbot-webroot:/var/www/certbot:ro # Mount certbot webroot for ACME challenge
    depends_on:
      web:
        # condition: service_healthy
    networks:
      - fansboda-network
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost/" ]
      interval: 300s
      timeout: 10s
      retries: 3

  # Nginx for ACME challenge only (runs temporarily)
  nginx-acme:
    image: nginx:alpine
    container_name: fansboda-nginx-acme
    restart: "no" # Only run when needed
    ports:
      - "80:80" # Use different port to avoid conflict
    volumes:
      - ./nginx-acme.conf:/etc/nginx/nginx.conf:ro
      - ./certbot-webroot:/var/www/certbot:ro
    networks:
      - fansboda-network
    profiles:
      - acme # Only start with --profile acme
    # Certbot for initial certificate
  certbot:
    image: certbot/certbot:latest
    container_name: fansboda-certbot
    restart: "no" # Run once
    volumes:
      - ./certificates:/etc/letsencrypt:rw
      - ./certbot-webroot:/var/www/certbot:rw
    command: certonly --webroot --webroot-path=/var/www/certbot --email olof.thornell@gmail.com --agree-tos --no-eff-email -d dev.fansboda.dpdns.org
    depends_on:
      - nginx-acme
    networks:
      - fansboda-network
    profiles:
      - acme # Only start with --profile acme

  # Certbot renewal service
  certbot-renew:
    image: certbot/certbot:latest
    container_name: fansboda-certbot-renew
    restart: unless-stopped
    volumes:
      - ./certificates:/etc/letsencrypt:rw
      - ./certbot-webroot:/var/www/certbot:rw
    command: sh -c "trap exit TERM; while :; do certbot renew --webroot --webroot-path=/var/www/certbot; sleep 12h & wait $${!}; done;"
    depends_on:
      - nginx
    networks:
      - fansboda-network

networks:
  fansboda-network:
    driver: bridge
